const KEYBOARD = [{
        print: true,
        text: { en: "`", ru: "ё" },
        capslock: { en: "`", ru: "Ё" },
        shift: {
            isCaps: { en: "~", ru: "ё" },
            notCaps: { en: "~", ru: "Ё" },
        },
        code: "Backquote",
    },
    {
        print: true,
        text: { en: "1", ru: "1" },
        capslock: { en: "1", ru: "1" },
        shift: {
            isCaps: { en: "!", ru: "!" },
            notCaps: { en: "!", ru: "!" },
        },
        code: "Digit1",
    },
    {
        print: true,
        text: { en: "2", ru: "2" },
        capslock: { en: "2", ru: "2" },
        shift: {
            isCaps: { en: "@", ru: '"' },
            notCaps: { en: "@", ru: '"' },
        },
        code: "Digit2",
    },
    {
        print: true,
        text: { en: "3", ru: "3" },
        capslock: { en: "3", ru: "3" },
        shift: {
            isCaps: { en: "#", ru: "№" },
            notCaps: { en: "#", ru: "№" },
        },
        code: "Digit3",
    },
    {
        print: true,
        text: { en: "4", ru: "4" },
        capslock: { en: "4", ru: "4" },
        shift: {
            isCaps: { en: "$", ru: ";" },
            notCaps: { en: "$", ru: ";" },
        },
        code: "Digit4",
    },
    {
        print: true,
        text: { en: "5", ru: "5" },
        capslock: { en: "5", ru: "5" },
        shift: {
            isCaps: { en: "%", ru: "%" },
            notCaps: { en: "%", ru: "%" },
        },
        code: "Digit5",
    },
    {
        print: true,
        text: { en: "6", ru: "6" },
        capslock: { en: "6", ru: "6" },
        shift: {
            isCaps: { en: "^", ru: ":" },
            notCaps: { en: "^", ru: ":" },
        },
        code: "Digit6",
    },
    {
        print: true,
        text: { en: "7", ru: "7" },
        capslock: { en: "7", ru: "7" },
        shift: {
            isCaps: { en: "&", ru: "?" },
            notCaps: { en: "&", ru: "?" },
        },
        code: "Digit7",
    },
    {
        print: true,
        text: { en: "8", ru: "8" },
        capslock: { en: "8", ru: "8" },
        shift: {
            isCaps: { en: "*", ru: "*" },
            notCaps: { en: "*", ru: "*" },
        },
        code: "Digit8",
    },
    {
        print: true,
        text: { en: "9", ru: "9" },
        capslock: { en: "9", ru: "9" },
        shift: {
            isCaps: { en: "(", ru: "(" },
            notCaps: { en: "(", ru: "(" },
        },
        code: "Digit9",
    },
    {
        print: true,
        text: { en: "0", ru: "0" },
        capslock: { en: "0", ru: "0" },
        shift: {
            isCaps: { en: ")", ru: ")" },
            notCaps: { en: ")", ru: ")" },
        },
        code: "Digit0",
    },
    {
        print: true,
        text: { en: "-", ru: "-" },
        capslock: { en: "-", ru: "-" },
        shift: {
            isCaps: { en: "_", ru: "_" },
            notCaps: { en: "_", ru: "_" },
        },
        code: "Minus",
    },
    {
        print: true,
        text: { en: "=", ru: "=" },
        capslock: { en: "=", ru: "=" },
        shift: {
            isCaps: { en: "+", ru: "+" },
            notCaps: { en: "+", ru: "+" },
        },
        code: "Equal",
    },
    {
        print: false,
        text: { en: "Backspace", ru: "Backspace" },
        capslock: { en: "Backspace", ru: "Backspace" },
        shift: {
            isCaps: { en: "Backspace", ru: "Backspace" },
            notCaps: { en: "Backspace", ru: "Backspace" },
        },
        code: "Backspace",
    },
    {
        print: false,
        text: { en: "Tab", ru: "Tab" },
        capslock: { en: "Tab", ru: "Tab" },
        shift: {
            isCaps: { en: "Tab", ru: "Tab" },
            notCaps: { en: "Tab", ru: "Tab" },
        },
        code: "Tab",
    },
    {
        print: true,
        text: { en: "q", ru: "й" },
        capslock: { en: "Q", ru: "Й" },
        shift: {
            isCaps: { en: "q", ru: "й" },
            notCaps: { en: "Q", ru: "Й" },
        },
        code: "KeyQ",
    },
    {
        print: true,
        text: { en: "w", ru: "ц" },
        capslock: { en: "W", ru: "Ц" },
        shift: {
            isCaps: { en: "w", ru: "ц" },
            notCaps: { en: "W", ru: "Ц" },
        },
        code: "KeyW",
    },
    {
        print: true,
        text: { en: "e", ru: "у" },
        capslock: { en: "E", ru: "У" },
        shift: {
            isCaps: { en: "e", ru: "у" },
            notCaps: { en: "E", ru: "У" },
        },
        code: "KeyE",
    },
    {
        print: true,
        text: { en: "r", ru: "к" },
        capslock: { en: "R", ru: "К" },
        shift: {
            isCaps: { en: "r", ru: "к" },
            notCaps: { en: "R", ru: "К" },
        },
        code: "KeyR",
    },
    {
        print: true,
        text: { en: "t", ru: "е" },
        capslock: { en: "T", ru: "Е" },
        shift: {
            isCaps: { en: "t", ru: "е" },
            notCaps: { en: "T", ru: "Е" },
        },
        code: "KeyT",
    },
    {
        print: true,
        text: { en: "y", ru: "н" },
        capslock: { en: "Y", ru: "Н" },
        shift: {
            isCaps: { en: "y", ru: "н" },
            notCaps: { en: "Y", ru: "Н" },
        },
        code: "KeyY",
    },
    {
        print: true,
        text: { en: "u", ru: "г" },
        capslock: { en: "U", ru: "Г" },
        shift: {
            isCaps: { en: "u", ru: "г" },
            notCaps: { en: "U", ru: "Г" },
        },
        code: "KeyU",
    },
    {
        print: true,
        text: { en: "i", ru: "ш" },
        capslock: { en: "I", ru: "Ш" },
        shift: {
            isCaps: { en: "i", ru: "ш" },
            notCaps: { en: "I", ru: "Ш" },
        },
        code: "KeyI",
    },
    {
        print: true,
        text: { en: "o", ru: "щ" },
        capslock: { en: "O", ru: "Щ" },
        shift: {
            isCaps: { en: "o", ru: "щ" },
            notCaps: { en: "O", ru: "Щ" },
        },
        code: "KeyO",
    },
    {
        print: true,
        text: { en: "p", ru: "з" },
        capslock: { en: "P", ru: "З" },
        shift: {
            isCaps: { en: "p", ru: "з" },
            notCaps: { en: "P", ru: "З" },
        },
        code: "KeyP",
    },
    {
        print: true,
        text: { en: "[", ru: "х" },
        capslock: { en: "[", ru: "Х" },
        shift: {
            isCaps: { en: "{", ru: "х" },
            notCaps: { en: "{", ru: "Х" },
        },
        code: "BracketLeft",
    },
    {
        print: true,
        text: { en: "]", ru: "ъ" },
        capslock: { en: "]", ru: "Ъ" },
        shift: {
            isCaps: { en: "}", ru: "ъ" },
            notCaps: { en: "}", ru: "Ъ" },
        },
        code: "BracketRight",
    },
    {
        print: true,
        text: { en: "\\", ru: "\\" },
        capslock: { en: "\\", ru: "\\" },
        shift: {
            isCaps: { en: "/", ru: "/" },
            notCaps: { en: "/", ru: "/" },
        },
        code: "Backslash",
    },
    {
        print: false,
        text: { en: "DEL", ru: "DEL" },
        capslock: { en: "DEL", ru: "DEL" },
        shift: {
            isCaps: { en: "DEL", ru: "DEL" },
            notCaps: { en: "DEL", ru: "DEL" },
        },
        code: "Delete",
    },
    {
        print: false,
        text: { en: "Caps Lock", ru: "Caps Lock" },
        capslock: { en: "Caps Lock", ru: "Caps Lock" },
        shift: {
            isCaps: { en: "Caps Lock", ru: "Caps Lock" },
            notCaps: { en: "Caps Lock", ru: "Caps Lock" },
        },
        code: "CapsLock",
    },
    {
        print: true,
        text: { en: "a", ru: "ф" },
        capslock: { en: "A", ru: "Ф" },
        shift: {
            isCaps: { en: "a", ru: "ф" },
            notCaps: { en: "A", ru: "Ф" },
        },
        code: "KeyA",
    },
    {
        print: true,
        text: { en: "s", ru: "ы" },
        capslock: { en: "S", ru: "Ы" },
        shift: {
            isCaps: { en: "s", ru: "ы" },
            notCaps: { en: "S", ru: "Ы" },
        },
        code: "KeyS",
    },
    {
        print: true,
        text: { en: "d", ru: "в" },
        capslock: { en: "D", ru: "В" },
        shift: {
            isCaps: { en: "d", ru: "в" },
            notCaps: { en: "D", ru: "В" },
        },
        code: "KeyD",
    },
    {
        print: true,
        text: { en: "f", ru: "а" },
        capslock: { en: "F", ru: "А" },
        shift: {
            isCaps: { en: "f", ru: "а" },
            notCaps: { en: "F", ru: "А" },
        },
        code: "KeyF",
    },
    {
        print: true,
        text: { en: "g", ru: "п" },
        capslock: { en: "G", ru: "П" },
        shift: {
            isCaps: { en: "g", ru: "п" },
            notCaps: { en: "G", ru: "П" },
        },
        code: "KeyG",
    },
    {
        print: true,
        text: { en: "h", ru: "р" },
        capslock: { en: "H", ru: "Р" },
        shift: {
            isCaps: { en: "h", ru: "р" },
            notCaps: { en: "H", ru: "Р" },
        },
        code: "KeyH",
    },
    {
        print: true,
        text: { en: "j", ru: "о" },
        capslock: { en: "J", ru: "О" },
        shift: {
            isCaps: { en: "j", ru: "о" },
            notCaps: { en: "J", ru: "О" },
        },
        code: "KeyJ",
    },
    {
        print: true,
        text: { en: "k", ru: "л" },
        capslock: { en: "K", ru: "Л" },
        shift: {
            isCaps: { en: "k", ru: "л" },
            notCaps: { en: "K", ru: "Л" },
        },
        code: "KeyK",
    },
    {
        print: true,
        text: { en: "l", ru: "д" },
        capslock: { en: "L", ru: "Д" },
        shift: {
            isCaps: { en: "l", ru: "д" },
            notCaps: { en: "L", ru: "Д" },
        },
        code: "KeyL",
    },
    {
        print: true,
        text: { en: ";", ru: "ж" },
        capslock: { en: ";", ru: "Ж" },
        shift: {
            isCaps: { en: ":", ru: "ж" },
            notCaps: { en: ":", ru: "Ж" },
        },
        code: "Semicolon",
    },
    {
        print: true,
        text: { en: "'", ru: "э" },
        capslock: { en: "'", ru: "Э" },
        shift: {
            isCaps: { en: '"', ru: "э" },
            notCaps: { en: '"', ru: "Э" },
        },
        code: "Quote",
    },
    {
        print: false,
        text: { en: "Enter", ru: "Enter" },
        capslock: { en: "Enter", ru: "Enter" },
        shift: {
            isCaps: { en: "Enter", ru: "Enter" },
            notCaps: { en: "Enter", ru: "Enter" },
        },
        code: "Enter",
    },
    {
        print: false,
        text: { en: "Shift", ru: "Shift" },
        capslock: { en: "Shift", ru: "Shift" },
        shift: {
            isCaps: { en: "Shift", ru: "Shift" },
            notCaps: { en: "Shift", ru: "Shift" },
        },
        code: "ShiftLeft",
    },
    {
        print: true,
        text: { en: "z", ru: "я" },
        capslock: { en: "Z", ru: "Я" },
        shift: {
            isCaps: { en: "z", ru: "я" },
            notCaps: { en: "Z", ru: "Я" },
        },
        code: "KeyZ",
    },
    {
        print: true,
        text: { en: "x", ru: "ч" },
        capslock: { en: "X", ru: "Ч" },
        shift: {
            isCaps: { en: "x", ru: "ч" },
            notCaps: { en: "X", ru: "Ч" },
        },
        code: "KeyX",
    },
    {
        print: true,
        text: { en: "c", ru: "с" },
        capslock: { en: "C", ru: "С" },
        shift: {
            isCaps: { en: "c", ru: "с" },
            notCaps: { en: "C", ru: "С" },
        },
        code: "KeyC",
    },
    {
        print: true,
        text: { en: "v", ru: "м" },
        capslock: { en: "V", ru: "М" },
        shift: {
            isCaps: { en: "v", ru: "м" },
            notCaps: { en: "V", ru: "М" },
        },
        code: "KeyV",
    },
    {
        print: true,
        text: { en: "b", ru: "и" },
        capslock: { en: "B", ru: "И" },
        shift: {
            isCaps: { en: "b", ru: "и" },
            notCaps: { en: "B", ru: "И" },
        },
        code: "KeyB",
    },
    {
        print: true,
        text: { en: "n", ru: "т" },
        capslock: { en: "N", ru: "Т" },
        shift: {
            isCaps: { en: "n", ru: "т" },
            notCaps: { en: "N", ru: "Т" },
        },
        code: "KeyN",
    },
    {
        print: true,
        text: { en: "m", ru: "ь" },
        capslock: { en: "M", ru: "Ь" },
        shift: {
            isCaps: { en: "m", ru: "ь" },
            notCaps: { en: "M", ru: "Ь" },
        },
        code: "KeyM",
    },
    {
        print: true,
        text: { en: ",", ru: "б" },
        capslock: { en: ",", ru: "Б" },
        shift: {
            isCaps: { en: "<", ru: "б" },
            notCaps: { en: "<", ru: "Б" },
        },
        code: "Comma",
    },
    {
        print: true,
        text: { en: ".", ru: "ю" },
        capslock: { en: ".", ru: "Ю" },
        shift: {
            isCaps: { en: ">", ru: "ю" },
            notCaps: { en: ">", ru: "Ю" },
        },
        code: "Period",
    },
    {
        print: true,
        text: { en: "/", ru: "." },
        capslock: { en: "/", ru: "." },
        shift: {
            isCaps: { en: "?", ru: "," },
            notCaps: { en: "?", ru: "," },
        },
        code: "Slash",
    },
    {
        print: false,
        text: { en: "▲", ru: "▲" },
        capslock: { en: "▲", ru: "▲" },
        shift: {
            isCaps: { en: "▲", ru: "▲" },
            notCaps: { en: "▲", ru: "▲" },
        },
        code: "ArrowUp",
    },
    {
        print: false,
        text: { en: "Shift", ru: "Shift" },
        capslock: { en: "Shift", ru: "Shift" },
        shift: {
            isCaps: { en: "Shift", ru: "Shift" },
            notCaps: { en: "Shift", ru: "Shift" },
        },
        code: "ShiftRight",
    },
    {
        print: false,
        text: { en: "Ctrl", ru: "Ctrl" },
        capslock: { en: "Ctrl", ru: "Ctrl" },
        shift: {
            isCaps: { en: "Ctrl", ru: "Ctrl" },
            notCaps: { en: "Ctrl", ru: "Ctrl" },
        },
        code: "ControlLeft",
    },
    {
        print: false,
        text: { en: "EN", ru: "RU" },
        capslock: { en: "EN", ru: "RU" },
        shift: {
            isCaps: { en: "EN", ru: "RU" },
            notCaps: { en: "EN", ru: "RU" },
        },
        code: "En/Ru",
    },
    {
        print: false,
        text: { en: "Alt", ru: "Alt" },
        capslock: { en: "Alt", ru: "Alt" },
        shift: {
            isCaps: { en: "Alt", ru: "Alt" },
            notCaps: { en: "Alt", ru: "Alt" },
        },
        code: "AltLeft",
    },
    {
        print: true,
        text: { en: " ", ru: " " },
        capslock: { en: " ", ru: " " },
        shift: {
            isCaps: { en: " ", ru: " " },
            notCaps: { en: " ", ru: " " },
        },
        code: "Space",
    },

    {
        print: false,
        text: { en: "", ru: "" },
        capslock: { en: "", ru: "" },
        shift: {
            isCaps: { en: "", ru: "" },
            notCaps: { en: "", ru: "" },
        },
        code: "Sound",
    },
    {
        print: false,
        text: { en: "◄", ru: "◄" },
        capslock: { en: "◄", ru: "◄" },
        shift: {
            isCaps: { en: "◄", ru: "◄" },
            notCaps: { en: "◄", ru: "◄" },
        },
        code: "ArrowLeft",
    },
    {
        print: false,
        text: { en: "▼", ru: "▼" },
        capslock: { en: "▼", ru: "▼" },
        shift: {
            isCaps: { en: "▼", ru: "▼" },
            notCaps: { en: "▼", ru: "▼" },
        },
        code: "ArrowDown",
    },
    {
        print: false,
        text: { en: "►", ru: "►" },
        capslock: { en: "►", ru: "►" },
        shift: {
            isCaps: { en: "►", ru: "►" },
            notCaps: { en: "►", ru: "►" },
        },
        code: "ArrowRight",
    },
    {
        print: false,
        text: { en: "", ru: "" },
        capslock: { en: "", ru: "" },
        shift: {
            isCaps: { en: "", ru: "" },
            notCaps: { en: "", ru: "" },
        },
        code: "Micro",
    },
];
// create html elements
const wrapper = document.querySelector('.wrapper');

const textarea = document.querySelector(".screen");

const hideKeyboard = document.querySelector('.hideKeyboard__btn');

const keyboard = document.createElement("div");
keyboard.classList.add("keyboard");
keyboard.classList.add("keyboard--hidden");
wrapper.appendChild(keyboard);
const description = document.createElement("p");
description.classList.add("description");
description.innerHTML +=
    "Смена раскладки: кнопка \"EN\"/\"RU\" ИЛИ Ctrl + Alt<br>" +
    "Клавиатура создана в операционной системе Windows";
wrapper.appendChild(description);

let isCaps = false;
let isShift = false;
let langEn = true;
let microOn = false;
let stateVolume = true;

window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const recognition = new SpeechRecognition();
recognition.interimResults = true;


recognition.addEventListener('result', e => {
    const transcript = Array.from(e.results)
        .map(result => result[0])
        .map(result => result.transcript)
        .join('');
    if (e.results[0].isFinal) {
        textarea.selectionStart = textarea.selectionEnd = textarea.value.length;
        textarea.setRangeText(
            transcript + ' ',
            textarea.selectionStart,
            textarea.selectionEnd,
            "end"
        );
    }
});

recognition.addEventListener('end', () => {
    if (microOn)
        recognition.start();
    else recognition.stop();
});

textarea.onblur = () => {
    textarea.focus();
};

function capslockActive(isCaps) {
    isCaps
        ?
        document
        .querySelector('.keyboard-key[data-code="CapsLock"]')
        .classList.add("active-special") :
        document
        .querySelector('.keyboard-key[data-code="CapsLock"]')
        .classList.remove("active-special");
}

function shiftActive(isShift) {
    if (isShift) {
        document
            .querySelector('.keyboard-key[data-code="ShiftLeft"]')
            .classList.add("active-special");
        document
            .querySelector('.keyboard-key[data-code="ShiftRight"]')
            .classList.add("active-special");
    } else {
        document.querySelector('.keyboard-key[data-code="ShiftLeft"]')
            .classList.remove("active-special");
        document
            .querySelector('.keyboard-key[data-code="ShiftRight"]')
            .classList.remove("active-special");
    }
}

function moveCursor(direction, cursorPosition) {
    switch (direction) {
        case "left":
            if (cursorPosition > 0) {
                cursorPosition -= 1;
            }
            return cursorPosition;
        case "right":
            if (cursorPosition < textarea.value.length) {
                cursorPosition += 1;
            }
            return cursorPosition;
        case "up":
            cursorPosition -= 50;
            if (cursorPosition - 50 < 0) {
                cursorPosition = 0;
            }
            return cursorPosition;
        default:
            cursorPosition += 50;
            if (cursorPosition > textarea.value.length) {
                cursorPosition = textarea.value.length;
            }
            return cursorPosition;
    }
}

function keyboardDraw(langEn) {
    let out = "";
    for (let i = 0; i < KEYBOARD.length; i++) {
        if (i === 14 || i === 29 || i === 42 || i === 55)
            out += '<div class="clear"></div>';
        if (langEn === true) {
            if (
                (i >= 0 && i < 12) ||
                (i > 14 && i < 27) ||
                (i > 29 && i < 41) ||
                (i > 42 && i < 53)
            ) {
                out +=
                    '<div class="keyboard-key" onclick="keyClick(event)"' +
                    `data-code="${KEYBOARD[i].code}">
                ${KEYBOARD[i].text.en}${KEYBOARD[
            i
          ].shift.isCaps.ru.sub()}</div>`;
            } else {
                out +=
                    '<div class="keyboard-key" onclick="keyClick(event)"' +
                    `data-code="${KEYBOARD[i].code}">${KEYBOARD[i].text.en}</div>`;
            }
        } else if (
            (i >= 0 && i < 12) ||
            (i > 14 && i < 27) ||
            (i > 29 && i < 41) ||
            (i > 42 && i < 53)
        ) {
            out +=
                '<div class="keyboard-key" onclick="keyClick(event)"' +
                `data-code="${KEYBOARD[i].code}">
        ${KEYBOARD[i].text.ru}${KEYBOARD[i].shift.isCaps.en.sub()}</div>`;
        } else {
            out +=
                '<div class="keyboard-key" onclick="keyClick(event)"' +
                `data-code="${KEYBOARD[i].code}">
        ${KEYBOARD[i].text.ru}</div>`;
        }
        keyboard.innerHTML = out;
    }
    capslockActive(isCaps);
    shiftActive(isShift);
    addIcons();
}

function addIcons() {
    document
        .querySelector(`.keyboard-key[data-code="Micro"]`)
        .classList.add("fa");
    document
        .querySelector(`.keyboard-key[data-code="Micro"]`)
        .classList.add("fa-microphone");
    document
        .querySelector(`.keyboard-key[data-code="Micro"]`)
        .classList.add("fa-2x");
    document
        .querySelector(`.keyboard-key[data-code="Sound"]`)
        .classList.add("fa-2x");
    document
        .querySelector(`.keyboard-key[data-code="Sound"]`)
        .classList.add("fa");
    document
        .querySelector(`.keyboard-key[data-code="Sound"]`)
        .classList.add("fa-volume-up");
}

function keyboardDrawCapsLock(langEn) {
    let out = "";
    for (let i = 0; i < KEYBOARD.length; i++) {
        if (i === 14 || i === 29 || i === 42 || i === 55)
            out += '<div class="clear"></div>';
        if (langEn) {
            if (
                (i >= 0 && i < 12) ||
                (i > 14 && i < 27) ||
                (i > 29 && i < 41) ||
                (i > 42 && i < 53)
            ) {
                out +=
                    '<div class="keyboard-key" onclick="keyClick(event)"' +
                    `data-code="${KEYBOARD[i].code}">
                    ${KEYBOARD[i].capslock.en}${KEYBOARD[
            i
          ].shift.notCaps.ru.sub()}</div>`;
            } else {
                out +=
                    '<div class="keyboard-key" onclick="keyClick(event)"' +
                    `data-code="${KEYBOARD[i].code}">${KEYBOARD[i].capslock.en}</div>`;
            }
        } else if (
            (i >= 0 && i < 12) ||
            (i > 14 && i < 27) ||
            (i > 29 && i < 41) ||
            (i > 42 && i < 53)
        ) {
            out +=
                '<div class="keyboard-key" onclick="keyClick(event)"' +
                `data-code="${KEYBOARD[i].code}">
        ${KEYBOARD[i].capslock.ru}${KEYBOARD[i].shift.notCaps.en.sub()}</div>`;
        } else {
            out +=
                '<div class="keyboard-key" onclick="keyClick(event)"' +
                `data-code="${KEYBOARD[i].code}">${KEYBOARD[i].capslock.ru}</div>`;
        }
    }
    keyboard.innerHTML = out;
    capslockActive(isCaps);
    shiftActive(isShift);
    addIcons();
}

function keyboardDrawSHIFT(langEn) {
    let out = "";
    for (let i = 0; i < KEYBOARD.length; i++) {
        if (i === 14 || i === 29 || i === 42 || i === 55)
            out += '<div class="clear"></div>';
        if (langEn && isCaps) {
            if (
                (i >= 0 && i < 12) ||
                (i > 14 && i < 27) ||
                (i > 29 && i < 41) ||
                (i > 42 && i < 53)
            ) {
                out +=
                    '<div class="keyboard-key" onclick="keyClick(event)"' +
                    `data-code="${KEYBOARD[i].code}">
            ${KEYBOARD[i].shift.isCaps.en}
            ${KEYBOARD[i].shift.isCaps.ru.sub()}</div>`;
            } else {
                out +=
                    '<div class="keyboard-key" onclick="keyClick(event)"' +
                    `data-code="${KEYBOARD[i].code}">${KEYBOARD[i].shift.isCaps.en}</div>`;
            }
        } else if (!langEn && isCaps) {
            if (
                i === 0 ||
                (i > 14 && i < 27) ||
                (i > 29 && i < 41) ||
                (i > 42 && i < 53)
            ) {
                out +=
                    '<div class="keyboard-key" onclick="keyClick(event)"' +
                    `data-code="${KEYBOARD[i].code}">
                ${KEYBOARD[i].shift.isCaps.ru}${KEYBOARD[
            i
          ].shift.isCaps.en.sub()}</div>`;
            } else {
                out +=
                    '<div class="keyboard-key" onclick="keyClick(event)"' +
                    `data-code="${KEYBOARD[i].code}">${KEYBOARD[i].shift.isCaps.ru}</div>`;
            }
        } else if (!langEn && !isCaps) {
            if (
                (i >= 0 && i < 12) ||
                (i > 14 && i < 27) ||
                (i > 29 && i < 41) ||
                (i > 42 && i < 53)
            ) {
                out +=
                    '<div class="keyboard-key" onclick="keyClick(event)"' +
                    `data-code="${KEYBOARD[i].code}">
            ${KEYBOARD[i].shift.notCaps.ru}
            ${KEYBOARD[i].shift.notCaps.en.sub()}</div>`;
            } else {
                out +=
                    '<div class="keyboard-key" onclick="keyClick(event)"' +
                    `data-code="${KEYBOARD[i].code}">${KEYBOARD[i].shift.notCaps.ru}</div>`;
            }
        } else if (
            i === 0 ||
            (i > 14 && i < 27) ||
            (i > 29 && i < 41) ||
            (i > 42 && i < 53)
        ) {
            out +=
                '<div class="keyboard-key" onclick="keyClick(event)"' +
                `data-code="${KEYBOARD[i].code}">
            ${KEYBOARD[i].shift.notCaps.en}
            ${KEYBOARD[i].shift.notCaps.ru.sub()}</div>`;
        } else {
            out +=
                '<div class="keyboard-key" onclick="keyClick(event)"' +
                `data-code="${KEYBOARD[i].code}">${KEYBOARD[i].shift.notCaps.en}</div>`;
        }
    }
    keyboard.innerHTML = out;
    capslockActive(isCaps);
    shiftActive(isShift);
    addIcons();
}


function specialKeys(event) {
    event.code = event.code || event.target.dataset.code;
    const cursorPosition = textarea.selectionStart;
    if (event.altKey && event.ctrlKey) {
        langEn ? (langEn = false) : (langEn = true);
        isCaps ? keyboardDrawCapsLock(langEn) : keyboardDraw(langEn);
    }
    if (event.code === 'En/Ru') {
        langEn ? (langEn = false) : (langEn = true);
        isCaps ? keyboardDrawCapsLock(langEn) : keyboardDraw(langEn);
    }
    if (event.code === 'Micro') {
        document
            .querySelector(`.keyboard-key[data-code="${event.code}"]`)
            .classList.toggle("active-special");
        document
            .querySelector(`.keyboard-key[data-code="${event.code}"]`)
            .classList.toggle("fa-microphone-slash");
        document
            .querySelector(`.keyboard-key[data-code="${event.code}"]`)
            .classList.toggle("fa-microphone");

        langEn ? recognition.lang = 'en-US' : recognition.lang = 'ru-RU';
        microOn ? microOn = false : microOn = true;
        microOn ? recognition.start() : recognition.stop();
    }
    if (event.code === 'Sound') {
        document
            .querySelector(`.keyboard-key[data-code="${event.code}"]`)
            .classList.toggle("fa-volume-off");
        document
            .querySelector(`.keyboard-key[data-code="${event.code}"]`)
            .classList.toggle("fa-volume-up");
        stateVolume ? stateVolume = false : stateVolume = true;
    }
    switch (event.code) {
        case "CapsLock":
            if (!isCaps) {
                isCaps = true;
                keyboardDrawCapsLock(langEn);
                capslockActive(isCaps);
            } else {
                isCaps = false;
                keyboardDraw(langEn);
                capslockActive(isCaps);
            }
            break;
        case "ShiftLeft":
        case "ShiftRight":
            if (!isShift) {
                isShift = true;
                keyboardDrawSHIFT(langEn);
                shiftActive(isShift);
            } else {
                isShift = false;
                keyboardDraw(langEn);
                shiftActive(isShift);
            }
            break;
        case "Tab":
            textarea.value += "    ";
            break;
        case "Backspace":
            textarea.selectionStart = moveCursor("left", cursorPosition);
            textarea.setRangeText("", textarea.selectionStart, textarea.selectionEnd);
            break;
        case "Delete":
            if (textarea.selectionStart === textarea.selectionEnd) {
                textarea.setRangeText(
                    "",
                    textarea.selectionStart,
                    textarea.selectionStart + 1
                );
            } else
                textarea.setRangeText(
                    "",
                    textarea.selectionStart,
                    textarea.selectionEnd
                );
            break;
        case "ArrowLeft":
            textarea.selectionStart = moveCursor("left", cursorPosition);
            textarea.selectionEnd = textarea.selectionStart;
            break;
        case "ArrowRight":
            textarea.selectionStart = moveCursor("right", cursorPosition);
            break;
        case "ArrowUp":
            textarea.selectionStart = moveCursor("up", cursorPosition);
            textarea.selectionEnd = textarea.selectionStart;
            break;
        case "ArrowDown":
            textarea.selectionStart = moveCursor("down", cursorPosition);
            textarea.selectionEnd = textarea.selectionStart;
            break;
        case "Enter":
            textarea.value += "\n";
            break;
        default:
            break;
    }
}

function findKey(event) {
    if (event.target.tagName === "SUB") {
        event.code = event.currentTarget.dataset.code
    } else {
        event.code = event.code || event.target.dataset.code;
    }
    const key = KEYBOARD.find((elem) => elem.code === event.code);
    if (key.print) return key;
    specialKeys(event);
}

function keyHandler(event) {
    if (event.target.tagName === "SUB") {
        event.code = event.currentTarget.dataset.code
    } else {
        event.code = event.code || event.target.dataset.code;
    }
    const key = findKey(event);
    if (key) {
        textarea.focus();
        if (langEn && !isCaps && !isShift) {
            textarea.setRangeText(
                key.text.en,
                textarea.selectionStart,
                textarea.selectionEnd,
                "end"
            );
        } else if (langEn && isCaps && !isShift) {
            textarea.setRangeText(
                key.capslock.en,
                textarea.selectionStart,
                textarea.selectionEnd,
                "end"
            );
        } else if (!langEn && !isCaps && !isShift) {
            textarea.setRangeText(
                key.text.ru,
                textarea.selectionStart,
                textarea.selectionEnd,
                "end"
            );
        } else if (!langEn && isCaps && !isShift) {
            textarea.setRangeText(
                key.capslock.ru,
                textarea.selectionStart,
                textarea.selectionEnd,
                "end"
            );
        } else if (langEn && !isCaps && isShift) {
            textarea.setRangeText(
                key.shift.notCaps.en,
                textarea.selectionStart,
                textarea.selectionEnd,
                "end"
            );
        } else if (!langEn && !isCaps && isShift) {
            textarea.setRangeText(
                key.shift.notCaps.ru,
                textarea.selectionStart,
                textarea.selectionEnd,
                "end"
            );
        } else if (langEn && isCaps && isShift) {
            textarea.setRangeText(
                key.shift.isCaps.en,
                textarea.selectionStart,
                textarea.selectionEnd,
                "end"
            );
        } else if (!langEn && isCaps && isShift) {
            textarea.setRangeText(
                key.shift.isCaps.ru,
                textarea.selectionStart,
                textarea.selectionEnd,
                "end"
            );
        }
    }
}

window.onload = () => {
    keyboardDraw(langEn);
};

document.onkeydown = function(event) {
    event.preventDefault();
    textarea.scrollTop = textarea.scrollHeight;
    playSound(event, langEn, stateVolume);
    if (!event.repeat) {
        document
            .querySelector(`.keyboard-key[data-code="${event.code}"]`)
            .classList.add("active");
        keyHandler(event);
    } else if (
        KEYBOARD.find((elem) => elem.code === event.code).print === true ||
        event.code === "Backspace" ||
        event.code === "Delete" ||
        event.code === "ArrowLeft" ||
        event.code === "ArrowRight" ||
        event.code === "ArrowUp" ||
        event.code === "ArrowDown"
    ) {
        keyHandler(event);
    }
};

document.onkeyup = function(event) {
    document
        .querySelector(`.keyboard-key[data-code="${event.code}"]`)
        .classList.remove("active");
};

function keyClick(event) {
    keyHandler(event);
    if (event.target.tagName === "SUB") {
        document
            .querySelector(`.keyboard-key[data-code="${event.currentTarget.dataset.code}"]`)
            .classList.add("active-click");
        document
            .querySelector(`.keyboard-key[data-code="${event.currentTarget.dataset.code}"]`)
            .addEventListener("animationend", function() {
                this.classList.remove("active-click");
            });
    } else {
        document
            .querySelector(`.keyboard-key[data-code="${event.target.dataset.code}"]`)
            .classList.add("active-click");
        document
            .querySelector(`.keyboard-key[data-code="${event.target.dataset.code}"]`)
            .addEventListener("animationend", function() {
                this.classList.remove("active-click");
            });
    }
    playSound(event, langEn, stateVolume);
}

hideKeyboard.onclick = function() {
    keyboard.classList.toggle('keyboard--hidden');
    description.classList.toggle('description--hidden');
}

function playSound(event, langEn, state) {
    if (!state) return;
    const audio = document.querySelectorAll(`audio`);
    if (!audio) return;
    if (KEYBOARD.find((elem) => elem.code === event.code).print === true) {
        if (langEn) {
            audio[1].currentTime = 0;
            audio[1].play();
        } else {
            audio[0].currentTime = 0;
            audio[0].play();
        }
    } else {
        if (langEn) {
            audio[0].currentTime = 0;
            audio[0].play();
        } else {
            audio[1].currentTime = 0;
            audio[1].play();
        }
    }
}